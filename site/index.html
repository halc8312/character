<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>キャラクター一覧 | Character Database</title>
  <link rel="stylesheet" href="assets/app.css">
</head>
<body>
  <a href="#mainContent" class="skip-link">メインコンテンツへスキップ</a>
  <header class="header">
    <h1>キャラクターデータベース</h1>
    <nav>
      <a href="index.html" class="active">一覧</a>
      <a href="graph.html">相関図</a>
      <a href="locations.html">ロケーション</a>
    </nav>
  </header>
  
  <main class="container" id="mainContent">
    <div class="search-bar">
      <input 
        type="text" 
        id="searchInput" 
        class="search-input" 
        placeholder="名前、ローマ字、別名、IDで検索..."
        autocomplete="off"
        aria-label="キャラクターを検索"
      >
      <button type="button" id="clearFilters" class="button secondary">クリア</button>
    </div>
    
    <div class="filter-section" id="filterSection">
      <h3>タグで絞り込み</h3>
      <div id="roleFilters" class="filter-group" style="margin-bottom: 0.75rem;">
        <!-- Role filters will be inserted here -->
      </div>
      <div id="factionFilters" class="filter-group">
        <!-- Faction filters will be inserted here -->
      </div>
    </div>
    
    <div class="status-bar">
      <span id="resultCount">読み込み中...</span>
      <span id="activeFilters" class="active-filters"></span>
    </div>
    
    <div id="characterGrid" class="character-grid">
      <div class="loading">データを読み込んでいます...</div>
    </div>
  </main>
  
  <script src="assets/app.js"></script>
  <script>
    let allCharacters = [];
    let activeTags = new Set();
    
    /**
     * Render character cards
     */
    function renderCharacters(characters, options = {}) {
      const grid = document.getElementById('characterGrid');
      const countEl = document.getElementById('resultCount');
      const isFiltered = options.isFiltered || false;
      
      if (characters.length === 0) {
        grid.innerHTML = `
          <div class="no-results">
            <h3>キャラクターが見つかりません</h3>
            <p>検索条件を変更してください</p>
          </div>
        `;
        countEl.textContent = '0件';
        return;
      }
      
      countEl.textContent = `${characters.length}件${isFiltered ? '（絞り込み中）' : ''}`;
      
      grid.innerHTML = characters.map(char => {
        const tags = (char.tags || []).slice(0, 4).map(t => App.createTagHtml(t)).join('');
        return `
          <a href="character.html?id=${App.escapeHtml(char.id)}" class="character-card">
            <h2>${App.escapeHtml(char.name_display)}</h2>
            <div class="romanized">${App.escapeHtml(char.name_romanized || char.id)}</div>
            <div class="summary">${App.escapeHtml(char.role_in_story || char.ai_summary || '')}</div>
            <div class="tags">${tags}</div>
          </a>
        `;
      }).join('');
    }
    
    /**
     * Render filter checkboxes
     */
    function renderFilters() {
      const roleFilters = document.getElementById('roleFilters');
      const factionFilters = document.getElementById('factionFilters');
      
      const roleTags = App.extractTagsByPrefix(allCharacters, 'role');
      const factionTags = App.extractTagsByPrefix(allCharacters, 'faction');
      
      // Render role filters
      roleFilters.innerHTML = roleTags.map(tag => `
        <button type="button" class="filter-tag" data-tag="${App.escapeHtml(tag)}" aria-pressed="false">
          ${App.escapeHtml(tag.split('/')[1])}
        </button>
      `).join('');
      
      // Render faction filters
      factionFilters.innerHTML = factionTags.map(tag => `
        <button type="button" class="filter-tag" data-tag="${App.escapeHtml(tag)}" aria-pressed="false">
          ${App.escapeHtml(tag.split('/')[1])}
        </button>
      `).join('');
      
      // Hide filter section if no filters
      const filterSection = document.getElementById('filterSection');
      if (roleTags.length === 0 && factionTags.length === 0) {
        filterSection.style.display = 'none';
      }
    }
    
    /**
     * Apply filters and search
     */
    function applyFiltersAndSearch() {
      const searchQuery = document.getElementById('searchInput').value;
      let filtered = App.searchCharacters(allCharacters, searchQuery);
      filtered = App.filterByTags(filtered, Array.from(activeTags));
      const isFiltered = Boolean(searchQuery.trim()) || activeTags.size > 0;
      renderCharacters(filtered, { isFiltered });
      renderActiveFilters(searchQuery);
    }
    
    /**
     * Render active filters summary
     */
    function renderActiveFilters(searchQuery) {
      const container = document.getElementById('activeFilters');
      const items = [];
      
      if (searchQuery && searchQuery.trim()) {
        items.push({
          type: 'search',
          label: `検索: ${searchQuery.trim()}`
        });
      }
      
      activeTags.forEach(tag => {
        const label = tag.includes('/') ? tag.split('/')[1] : tag;
        items.push({ type: 'tag', value: tag, label });
      });
      
      if (items.length === 0) {
        container.innerHTML = '<span class="active-filters-empty">絞り込みなし</span>';
        return;
      }
      
      container.innerHTML = items.map(item => `
        <span class="active-filter-chip" data-type="${item.type}" ${item.value ? `data-tag="${App.escapeHtml(item.value)}"` : ''}>
          ${App.escapeHtml(item.label)}
          <button type="button" class="remove" aria-label="フィルタを解除">×</button>
        </span>
      `).join('') + `
        <button type="button" class="button secondary" id="clearAllFilters">すべて解除</button>
      `;
    }
    
    /**
     * Clear all filters and search
     */
    function clearAllFilters() {
      activeTags.clear();
      document.getElementById('searchInput').value = '';
      document.querySelectorAll('.filter-tag').forEach(el => {
        el.classList.remove('active');
        el.setAttribute('aria-pressed', 'false');
      });
      applyFiltersAndSearch();
    }
    
    /**
     * Initialize the page
     */
    async function init() {
      try {
        await App.loadAllData();
        allCharacters = App.data.characters;
        
        renderFilters();
        renderCharacters(allCharacters, { isFiltered: false });
        renderActiveFilters('');
        
        // Search input handler
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', App.debounce(() => {
          applyFiltersAndSearch();
        }, 200));
        
        // Filter click handlers
        const filterSection = document.getElementById('filterSection');
        filterSection.addEventListener('click', function(e) {
          const button = e.target.closest('.filter-tag');
          if (!button) return;
          
          const tag = button.dataset.tag;
          
          if (activeTags.has(tag)) {
            activeTags.delete(tag);
            button.classList.remove('active');
            button.setAttribute('aria-pressed', 'false');
          } else {
            activeTags.add(tag);
            button.classList.add('active');
            button.setAttribute('aria-pressed', 'true');
          }
          
          applyFiltersAndSearch();
        });
        
        document.getElementById('clearFilters').addEventListener('click', clearAllFilters);
        
        document.getElementById('activeFilters').addEventListener('click', function(e) {
          if (e.target && e.target.id === 'clearAllFilters') {
            clearAllFilters();
            return;
          }
          const removeButton = e.target.closest('.remove');
          if (!removeButton) return;
          
          const chip = removeButton.closest('.active-filter-chip');
          if (!chip) return;
          
          const type = chip.dataset.type;
          if (type === 'search') {
            document.getElementById('searchInput').value = '';
          } else if (type === 'tag') {
            const tag = chip.dataset.tag;
            activeTags.delete(tag);
            const button = document.querySelector(`.filter-tag[data-tag="${tag}"]`);
            if (button) {
              button.classList.remove('active');
              button.setAttribute('aria-pressed', 'false');
            }
          }
          
          applyFiltersAndSearch();
        });
        
        // Check for pre-selected tag from URL
        const preTag = App.getQueryParam('tag');
        if (preTag) {
          activeTags.add(preTag);
          const tagEl = document.querySelector(`[data-tag="${preTag}"]`);
          if (tagEl) {
            tagEl.classList.add('active');
            tagEl.setAttribute('aria-pressed', 'true');
          }
          applyFiltersAndSearch();
        }
        
      } catch (error) {
        console.error('Failed to initialize:', error);
        document.getElementById('characterGrid').innerHTML = `
          <div class="error">データの読み込みに失敗しました</div>
        `;
      }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
